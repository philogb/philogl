/*

 Copyright (c) 2011 Sencha Labs - Author: Nicolas Garcia Belmonte (http://philogb.github.com/)

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 THE SOFTWARE.

*/
(function(){function v(x){return document.getElementById(x)}this.PhiloGL=null;(function(){PhiloGL=function(x,y){function r(s,z,t){var B=s.canvas,a=new PhiloGL.Camera(d.fov,B.width/B.height,d.near,d.far,d);a.update();var b=new PhiloGL.Scene(z,a,c);M=new PhiloGL.WebGL.Application({gl:s,canvas:B,program:z,scene:b,camera:a});z.$$family=="program"&&z.use();f&&PhiloGL.Events.create(M,v.extend(f,{bind:M}));if(h.src.length)new PhiloGL.IO.Textures(v.extend(h,{onComplete:function(){t(M)}}));else t(M)}y=v.merge({context:{},
camera:{fov:45,near:0.1,far:500},program:{from:"defaults",vs:"Default",fs:"Default"},scene:{},textures:{src:[]},events:{},onLoad:v.empty,onError:v.empty},y||{});var l=y.context,d=y.camera,f=y.events,h=y.textures,j=v.splat(y.program),c=y.scene;o=PhiloGL.WebGL.getContext(x,l);if(!o){y.onError("The WebGL context couldn't been initialized");return null}var k={defaults:"fromDefaultShaders",ids:"fromShaderIds",sources:"fromShaderSources",uris:"fromShaderURIs"},i=j.length,m=function(){var s=i,z={},t=false;
return{onSuccess:function(B,a){z[a.id||i-s]=B;s--;if(s===0&&!t)r(o,i==1?B:z,function(b){y.onLoad(b)})},onError:function(B){s--;y.onError(B);t=true}}}();j.forEach(function(s){var z=s.from,t,B;for(B in k)if(z==B){try{t=PhiloGL.Program[k[B]](v.extend(m,s))}catch(a){m.onError(a)}break}if(t)m.onSuccess(t,s)})}})();PhiloGL.unpack=function(x){x=x||aa;["Vec3","Mat4","Quat","Camera","Program","WebGL","O3D","Scene","Shaders","IO","Events","WorkerGroup","Fx","Media"].forEach(function(y){x[y]=PhiloGL[y]})};PhiloGL.version=
"1.4.3";var o,M,aa=this;v.empty=function(){};v.time=Date.now;v.uid=function(){var x=v.time();return function(){return x++}}();v.extend=function(x,y){for(var r in y)x[r]=y[r];return x};v.type=function(){var x=Object.prototype.toString;return function(y){var r;r=x.call(y);r=r.substr(8,r.length-9).toLowerCase();if(r!="object")return r;if(y.$$family)return y.$$family;return y&&y.nodeName&&y.nodeType==1?"element":r}}();(function(){function x(y){var r=v.type(y);if(r=="object"){r={};for(var l in y)r[l]=
x(y[l]);return r}else if(r=="array"){r=[];l=0;for(var d=y.length;l<d;l++)r[l]=x(y[l]);return r}else return y}v.merge=function(){for(var y={},r=0,l=arguments.length;r<l;r++){var d=arguments[r];if(v.type(d)=="object")for(var f in d){var h=d[f],j=y[f];y[f]=j&&v.type(h)=="object"&&v.type(j)=="object"?v.merge(j,h):x(h)}}return y}})();v.splat=function(){var x=Array.isArray;return function(y){return x(y)&&y||[y]}}();(function(){function x(r){for(var l in r)this[l]=r[l];this.buffers={};this.bufferMemo={};
this.frameBuffers={};this.frameBufferMemo={};this.renderBuffers={};this.renderBufferMemo={};this.textures={};this.textureMemo={}}var y={getContext:function(r,l){r=typeof r=="string"?v(r):r;var d;(d=r.getContext("experimental-webgl",l))||(d=r.getContext("webgl",l));if(d&&l&&l.debug){o={};for(var f in d){var h=d[f];o[f]=typeof h=="function"?function(j,c){return function(){console.log(j,Array.prototype.join.call(arguments),Array.prototype.slice.call(arguments));try{var k=c.apply(d,arguments)}catch(i){throw j+
" "+i;}for(var m=[],s;(s=d.getError())!==d.NO_ERROR;)m.push(s);if(m.length)throw m.join();return k}}(f,h):h}}else o=d;if(o)o.get=function(j){return typeof j=="string"?o[j]:j};return o}};x.prototype={$$family:"application",setBuffer:function(r,l,d){if(d===false||d===null){(d=this.bufferMemo[l])&&o.bindBuffer(d.bufferType,null);var f=d&&d.attribute||l;r=r.attributes[f];r!==undefined&&o.disableVertexAttribArray(r)}else{d=v.extend(this.bufferMemo[l]||{bufferType:o.ARRAY_BUFFER,size:1,dataType:o.FLOAT,
stride:0,offset:0,drawType:o.STATIC_DRAW},d||{});f=d.attribute||l;var h=d.bufferType,j=l in this.buffers,c=j?this.buffers[l]:o.createBuffer(),k="value"in d,i=d.value,m=d.size,s=d.dataType,z=d.stride,t=d.offset,B=d.drawType;r=r.attributes[f];var a=r!==undefined;j||(this.buffers[l]=c);a&&o.enableVertexAttribArray(r);o.bindBuffer(h,c);k&&o.bufferData(h,i,B);a&&o.vertexAttribPointer(r,m,s,false,z,t);delete d.value;this.bufferMemo[l]=d;if(a)this.bufferMemo[f]=d;return this}},setBuffers:function(r,l){for(var d in l)this.setBuffer(r,
d,l[d]);return this},setFrameBuffer:function(r,l){if(typeof l!="object")o.bindFramebuffer(o.FRAMEBUFFER,l?this.frameBuffers[r]:null);else{l=v.merge(this.frameBufferMemo[r]||{width:0,height:0,bindToTexture:false,textureOptions:{attachment:o.COLOR_ATTACHMENT0},bindToRenderBuffer:false,renderBufferOptions:{attachment:o.DEPTH_ATTACHMENT}},l||{});var d=l.bindToTexture,f=l.bindToRenderBuffer,h=r in this.frameBuffers,j=h?this.frameBuffers[r]:o.createFramebuffer();o.bindFramebuffer(o.FRAMEBUFFER,j);h||(this.frameBuffers[r]=
j);if(d){d=v.merge({data:{width:l.width,height:l.height}},v.type(d)=="object"?d:{});h=r+"-texture";j=l.textureOptions;this.setTexture(h,d);o.framebufferTexture2D(o.FRAMEBUFFER,j.attachment,this.textureMemo[h].textureType,this.textures[h],0)}if(f){f=v.extend({width:l.width,height:l.height},v.type(f)=="object"?f:{});d=r+"-renderbuffer";h=l.renderBufferOptions;this.setRenderBuffer(d,f);o.framebufferRenderbuffer(o.FRAMEBUFFER,h.attachment,o.RENDERBUFFER,this.renderBuffers[d])}o.bindTexture(o.TEXTURE_2D,
null);o.bindRenderbuffer(o.RENDERBUFFER,null);o.bindFramebuffer(o.FRAMEBUFFER,null);this.frameBufferMemo[r]=l;return this}},setFrameBuffers:function(r){for(var l in r)this.setFrameBuffer(l,r[l]);return this},setRenderBuffer:function(r,l){if(typeof l!="object")o.bindRenderbuffer(o.RENDERBUFFER,l?this.renderBufferMemo[r]:null);else{l=v.extend(this.renderBufferMemo[r]||{storageType:o.DEPTH_COMPONENT16,width:0,height:0},l||{});var d=r in this.renderBuffers,f=d?this.renderBuffers[r]:o.createRenderbuffer(o.RENDERBUFFER);
d||(this.renderBuffers[r]=f);o.bindRenderbuffer(o.RENDERBUFFER,f);o.renderbufferStorage(o.RENDERBUFFER,l.storageType,l.width,l.height);this.renderBufferMemo[r]=l;return this}},setRenderBuffers:function(r){for(var l in r)this.setRenderBuffer(l,r[l]);return this},setTexture:function(r,l){if(!l||typeof l!="object"){o.activeTexture(l||o.TEXTURE0);o.bindTexture(this.textureMemo[r].textureType||o.TEXTURE_2D,this.textures[r])}else{l.data&&l.data.type===o.FLOAT&&o.getExtension("OES_texture_float");l=v.merge(this.textureMemo[r]||
{textureType:o.TEXTURE_2D,pixelStore:[{name:o.UNPACK_FLIP_Y_WEBGL,value:true},{name:o.UNPACK_ALIGNMENT,value:1}],parameters:[{name:o.TEXTURE_MAG_FILTER,value:o.NEAREST},{name:o.TEXTURE_MIN_FILTER,value:o.NEAREST}],data:{format:o.RGBA,value:false,type:o.UNSIGNED_BYTE,width:0,height:0,border:0}},l||{});var d="textureType"in l?o.get(l.textureType):o.TEXTURE_2D,f="textureTarget"in l?o.get(l.textureTarget):d,h=d==o.TEXTURE_CUBE_MAP,j=r in this.textures,c=j?this.textures[r]:o.createTexture(),k=l.pixelStore,
i=l.parameters,m=l.data,s=m.value,z=m.type,t=m.format,B=!!m.value;j||(this.textures[r]=c);o.bindTexture(d,c);j||k.forEach(function(a){a.name=typeof a.name=="string"?o[a.name]:a.name;o.pixelStorei(a.name,a.value)});if(B)if(h)for(c=0;c<6;++c)o.texImage2D(f[c],0,t,t,z,s[c]);else o.texImage2D(f,0,t,t,z,s);else if(m.width||m.height)o.texImage2D(f,0,t,m.width,m.height,m.border,t,z,null);j||i.forEach(function(a){a.name=o.get(a.name);a.value=o.get(a.value);o.texParameteri(d,a.name,a.value);a.generateMipmap&&
o.generateMipmap(d)});l.isCube=h;if(B)l.data.value=false;this.textureMemo[r]=l;return this}},setTextures:function(r){for(var l in r)this.setTexture(l,r[l]);return this},use:function(r){o.useProgram(r.program);this.usedProgram=r;return this}};y.Application=x;(function(){try{var r=document.createElement("canvas");PhiloGL.hasWebGL=function(){return!!(window.WebGLRenderingContext&&(r.getContext("webgl")||r.getContext("experimental-webgl")))}}catch(l){PhiloGL.hasWebGL=function(){return false}}})();PhiloGL.WebGL=
y})();(function(){function x(a){return{get:function(){return this[a]},set:function(b){this[a]=b},configurable:false,enumerable:false}}var y=Math.sqrt,r=Math.sin,l=Math.cos,d=Math.tan,f=Math.PI,h=Array.prototype.slice,j=this.Float32Array,c=function(){if(!j||!j.call)return Array;try{j.call({},10)}catch(a){return Array}return j}(),k=c!=Array,i=function(a,b,g){if(k){j.call(this,3);this[0]=a||0;this[1]=b||0;this[2]=g||0}else this.push(a||0,b||0,g||0);this.typedContainer=new j(3)};i.create=function(){return new j(3)};
i.prototype=Object.create(c.prototype,{$$family:{value:"Vec3"},x:x(0),y:x(1),z:x(2)});var m={setVec3:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},set:function(a,b,g,n){a[0]=b;a[1]=g;a[2]=n;return a},add:function(a,b){return new i(a[0]+b[0],a[1]+b[1],a[2]+b[2])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];return a},add2:function(a,b,g){a[0]=b[0]+g[0];a[1]=b[1]+g[1];a[2]=b[2]+g[2];return a},sub:function(a,b){return new i(a[0]-b[0],a[1]-b[1],a[2]-b[2])},$sub:function(a,b){a[0]-=b[0];
a[1]-=b[1];a[2]-=b[2];return a},sub2:function(a,b,g){a[0]=b[0]-g[0];a[1]=b[1]-g[1];a[2]=b[2]-g[2];return a},scale:function(a,b){return new i(a[0]*b,a[1]*b,a[2]*b)},$scale:function(a,b){a[0]*=b;a[1]*=b;a[2]*=b;return a},neg:function(a){return new i(-a[0],-a[1],-a[2])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a},unit:function(a){var b=i.norm(a);if(b>0)return i.scale(a,1/b);return i.clone(a)},$unit:function(a){var b=i.norm(a);if(b>0)return i.$scale(a,1/b);return a},cross:function(a,b){var g=
a[0],n=a[1],p=a[2],q=b[0],u=b[1],w=b[2];return new i(n*w-p*u,p*q-g*w,g*u-n*q)},$cross:function(a,b){var g=a[0],n=a[1],p=a[2],q=b[0],u=b[1],w=b[2];a[0]=n*w-p*u;a[1]=p*q-g*w;a[2]=g*u-n*q;return a},distTo:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],p=a[2]-b[2];return y(g*g+n*n+p*p)},distToSq:function(a,b){var g=a[0]-b[0],n=a[1]-b[1],p=a[2]-b[2];return g*g+n*n+p*p},norm:function(a){var b=a[0],g=a[1];a=a[2];return y(b*b+g*g+a*a)},normSq:function(a){var b=a[0],g=a[1];a=a[2];return b*b+g*g+a*a},dot:function(a,
b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},clone:function(a){return a.$$family?new i(a[0],a[1],a[2]):i.setVec3(new j(3),a)},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];return b}},s=i.prototype,z;for(z in m){i[z]=m[z];s[z]=function(a){return function(){var b=h.call(arguments);b.unshift(this);return i[a].apply(i,b)}}(z)}var t=function(a,b,g,n,p,q,u,w,A,C,D,E,G,I,J,H){c.call(this,16);this.length=16;typeof a=="number"?this.set(a,b,g,n,p,q,u,w,A,C,D,E,G,
I,J,H):this.id();this.typedContainer=new j(16)};t.create=function(){return new j(16)};t.prototype=Object.create(c.prototype,{$$family:{value:"Mat4"},n11:x(0),n12:x(4),n13:x(8),n14:x(12),n21:x(1),n22:x(5),n23:x(9),n24:x(13),n31:x(2),n32:x(6),n33:x(10),n34:x(14),n41:x(3),n42:x(7),n43:x(11),n44:x(15)});m={id:function(a){a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},clone:function(a){return a.$$family?new t(a[0],a[4],a[8],
a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15]):new j(a)},set:function(a,b,g,n,p,q,u,w,A,C,D,E,G,I,J,H,F){a[0]=b;a[4]=g;a[8]=n;a[12]=p;a[1]=q;a[5]=u;a[9]=w;a[13]=A;a[2]=C;a[6]=D;a[10]=E;a[14]=G;a[3]=I;a[7]=J;a[11]=H;a[15]=F;return a},mulVec3:function(a,b){var g=i.clone(b);return t.$mulVec3(a,g)},$mulVec3:function(a,b){var g=b[0],n=b[1],p=b[2],q=1/(a[3]*g+a[7]*n+a[11]*p+a[15]);b[0]=(a[0]*g+a[4]*n+a[8]*p+a[12])*q;b[1]=(a[1]*g+a[5]*n+a[9]*p+a[13])*q;b[2]=(a[2]*g+a[6]*n+a[10]*
p+a[14])*q;return b},mulMat42:function(a,b,g){var n=b[0],p=b[1],q=b[2],u=b[3],w=b[4],A=b[5],C=b[6],D=b[7],E=b[8],G=b[9],I=b[10],J=b[11],H=b[12],F=b[13],N=b[14];b=b[15];var K=g[0],L=g[1],P=g[2],Q=g[3],R=g[4],U=g[5],V=g[6],W=g[7],S=g[8],T=g[9],X=g[10],O=g[11],Y=g[12],Z=g[13],$=g[14];g=g[15];a[0]=K*n+L*w+P*E+Q*H;a[1]=K*p+L*A+P*G+Q*F;a[2]=K*q+L*C+P*I+Q*N;a[3]=K*u+L*D+P*J+Q*b;a[4]=R*n+U*w+V*E+W*H;a[5]=R*p+U*A+V*G+W*F;a[6]=R*q+U*C+V*I+W*N;a[7]=R*u+U*D+V*J+W*b;a[8]=S*n+T*w+X*E+O*H;a[9]=S*p+T*A+X*G+O*F;a[10]=
S*q+T*C+X*I+O*N;a[11]=S*u+T*D+X*J+O*b;a[12]=Y*n+Z*w+$*E+g*H;a[13]=Y*p+Z*A+$*G+g*F;a[14]=Y*q+Z*C+$*I+g*N;a[15]=Y*u+Z*D+$*J+g*b;return a},mulMat4:function(a,b){var g=t.clone(a);return t.mulMat42(g,a,b)},$mulMat4:function(a,b){return t.mulMat42(a,a,b)},add:function(a,b){var g=t.clone(a);return t.$add(g,b)},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];a[4]+=b[4];a[5]+=b[5];a[6]+=b[6];a[7]+=b[7];a[8]+=b[8];a[9]+=b[9];a[10]+=b[10];a[11]+=b[11];a[12]+=b[12];a[13]+=b[13];a[14]+=b[14];a[15]+=
b[15];return a},transpose:function(a){a=t.clone(a);return t.$transpose(a)},$transpose:function(a){var b=a[8],g=a[12],n=a[1],p=a[9],q=a[13],u=a[2],w=a[6],A=a[14],C=a[3],D=a[7],E=a[11];a[1]=a[4];a[2]=b;a[3]=g;a[4]=n;a[6]=p;a[7]=q;a[8]=u;a[9]=w;a[11]=A;a[12]=C;a[13]=D;a[14]=E;return a},rotateAxis:function(a,b,g){a=t.clone(a);return t.$rotateAxis(a,b,g)},$rotateAxis:function(a,b,g){var n=r(b),p=l(b),q=1-p,u=g[0],w=g[1],A=g[2];g=u*u*q+p;b=u*w*q+A*n;var C=u*A*q-w*n,D=w*u*q-A*n,E=w*w*q+p,G=w*A*q+u*n,I=u*
A*q+w*n;n=w*A*q-u*n;p=A*A*q+p;q=a[0];u=a[1];w=a[2];A=a[3];var J=a[4],H=a[5],F=a[6],N=a[7],K=a[8],L=a[9],P=a[10],Q=a[11];a[0]=q*g+J*b+K*C;a[1]=u*g+H*b+L*C;a[2]=w*g+F*b+P*C;a[3]=A*g+N*b+Q*C;a[4]=q*D+J*E+K*G;a[5]=u*D+H*E+L*G;a[6]=w*D+F*E+P*G;a[7]=A*D+N*E+Q*G;a[8]=q*I+J*n+K*p;a[9]=u*I+H*n+L*p;a[10]=w*I+F*n+P*p;a[11]=A*I+N*n+Q*p;return a},rotateXYZ:function(a,b,g,n){a=t.clone(a);return t.$rotateXYZ(a,b,g,n)},$rotateXYZ:function(a,b,g,n){var p=a[0],q=a[1],u=a[2],w=a[3],A=a[4],C=a[5],D=a[6],E=a[7],G=a[8],
I=a[9],J=a[10],H=a[11],F=l(b),N=l(g),K=l(n);b=r(b);var L=r(g),P=r(n);n=N*K;g=-F*P+b*L*K;var Q=b*P+F*L*K,R=N*P,U=F*K+b*L*P;K=-b*K+F*L*P;L=-L;b*=N;F*=N;a[0]=p*n+A*R+G*L;a[1]=q*n+C*R+I*L;a[2]=u*n+D*R+J*L;a[3]=w*n+E*R+H*L;a[4]=p*g+A*U+G*b;a[5]=q*g+C*U+I*b;a[6]=u*g+D*U+J*b;a[7]=w*g+E*U+H*b;a[8]=p*Q+A*K+G*F;a[9]=q*Q+C*K+I*F;a[10]=u*Q+D*K+J*F;a[11]=w*Q+E*K+H*F;return a},translate:function(a,b,g,n){a=t.clone(a);return t.$translate(a,b,g,n)},$translate:function(a,b,g,n){a[12]=a[0]*b+a[4]*g+a[8]*n+a[12];a[13]=
a[1]*b+a[5]*g+a[9]*n+a[13];a[14]=a[2]*b+a[6]*g+a[10]*n+a[14];a[15]=a[3]*b+a[7]*g+a[11]*n+a[15];return a},scale:function(a,b,g,n){a=t.clone(a);return t.$scale(a,b,g,n)},$scale:function(a,b,g,n){a[0]*=b;a[1]*=b;a[2]*=b;a[3]*=b;a[4]*=g;a[5]*=g;a[6]*=g;a[7]*=g;a[8]*=n;a[9]*=n;a[10]*=n;a[11]*=n;return a},invert:function(a){a=t.clone(a);return t.$invert(a)},$invert:function(a){var b=a[0],g=a[1],n=a[2],p=a[3],q=a[4],u=a[5],w=a[6],A=a[7],C=a[8],D=a[9],E=a[10],G=a[11],I=a[12],J=a[13],H=a[14],F=a[15],N=b*u-
g*q,K=b*w-n*q,L=b*A-p*q,P=g*w-n*u,Q=g*A-p*u,R=n*A-p*w,U=C*J-D*I,V=C*H-E*I,W=C*F-G*I,S=D*H-E*J,T=D*F-G*J,X=E*F-G*H,O=1/(N*X-K*T+L*S+P*W-Q*V+R*U);a[0]=(+u*X-w*T+A*S)*O;a[1]=(-g*X+n*T-p*S)*O;a[2]=(+J*R-H*Q+F*P)*O;a[3]=(-D*R+E*Q-G*P)*O;a[4]=(-q*X+w*W-A*V)*O;a[5]=(+b*X-n*W+p*V)*O;a[6]=(-I*R+H*L-F*K)*O;a[7]=(+C*R-E*L+G*K)*O;a[8]=(+q*T-u*W+A*U)*O;a[9]=(-b*T+g*W-p*U)*O;a[10]=(+I*Q-J*L+F*N)*O;a[11]=(-C*Q+D*L-G*N)*O;a[12]=(-q*S+u*V-w*U)*O;a[13]=(+b*S-g*V+n*U)*O;a[14]=(-I*P+J*K-H*N)*O;a[15]=(+C*P-D*K+E*N)*O;
return a},lookAt:function(a,b,g,n){g=i.sub(b,g);g.$unit();n=i.cross(n,g);n.$unit();var p=i.cross(g,n);p.$unit();return t.set(a,n[0],n[1],n[2],-n.dot(b),p[0],p[1],p[2],-p.dot(b),g[0],g[1],g[2],-g.dot(b),0,0,0,1)},frustum:function(a,b,g,n,p,q,u){var w=g-b,A=p-n,C=u-q;a[0]=q*2/w;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=q*2/A;a[6]=0;a[7]=0;a[8]=(g+b)/w;a[9]=(p+n)/A;a[10]=-(u+q)/C;a[11]=-1;a[12]=0;a[13]=0;a[14]=-(u*q*2)/C;a[15]=0;return a},perspective:function(a,b,g,n,p){b=n*d(b*f/360);var q=-b;return t.frustum(a,
q*g,b*g,q,b,n,p)},ortho:function(a,b,g,n,p,q,u){var w=g-b,A=p-n,C=u-q;a[0]=2/w;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=2/A;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=-2/C;a[11]=0;a[12]=-(b+g)/w;a[13]=-(p+n)/A;a[14]=-(u+q)/C;a[15]=1;return a},toFloat32Array:function(a){var b=a.typedContainer;if(!b)return a;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return b}};s=t.prototype;for(z in m){t[z]=
m[z];s[z]=function(a){return function(){var b=h.call(arguments);b.unshift(this);return t[a].apply(t,b)}}(z)}var B=function(a,b,g,n){c.call(this,4);this[0]=a||0;this[1]=b||0;this[2]=g||0;this[3]=n||0;this.typedContainer=new j(4)};B.create=function(){return new j(4)};m={setQuat:function(a,b){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},set:function(a,b,g,n,p){a[0]=b||0;a[1]=g||0;a[2]=n||0;a[3]=p||0;return a},clone:function(a){return a.$$family?new B(a[0],a[1],a[2],a[3]):B.setQuat(new j(4),a)},
neg:function(a){return new B(-a[0],-a[1],-a[2],-a[3])},$neg:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];a[3]=-a[3];return a},add:function(a,b){return new B(a[0]+b[0],a[1]+b[1],a[2]+b[2],a[3]+b[3])},$add:function(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];a[3]+=b[3];return a},sub:function(a,b){return new B(a[0]-b[0],a[1]-b[1],a[2]-b[2],a[3]-b[3])},$sub:function(a,b){a[0]-=b[0];a[1]-=b[1];a[2]-=b[2];a[3]-=b[3];return a},scale:function(a,b){return new B(a[0]*b,a[1]*b,a[2]*b,a[3]*b)},$scale:function(a,b){a[0]*=
b;a[1]*=b;a[2]*=b;a[3]*=b;return a},mulQuat:function(a,b){var g=a[0],n=a[1],p=a[2],q=a[3],u=b[0],w=b[1],A=b[2],C=b[3];return new B(q*u+g*C+n*A-p*w,q*w+n*C+p*u-g*A,q*A+p*C+g*w-n*u,q*C-g*u-n*w-p*A)},$mulQuat:function(a,b){var g=a[0],n=a[1],p=a[2],q=a[3],u=b[0],w=b[1],A=b[2],C=b[3];a[0]=q*u+g*C+n*A-p*w;a[1]=q*w+n*C+p*u-g*A;a[2]=q*A+p*C+g*w-n*u;a[3]=q*C-g*u-n*w-p*A;return a},divQuat:function(a,b){var g=a[0],n=a[1],p=a[2],q=a[3],u=b[0],w=b[1],A=b[2],C=b[3],D=1/(C*C+u*u+w*w+A*A);return new B((g*C-q*u-n*
A+p*w)*D,(g*A-q*w+n*C-p*u)*D,(n*u+p*C-q*A-g*w)*D,(q*C+g*u+n*w+p*A)*D)},$divQuat:function(a,b){var g=a[0],n=a[1],p=a[2],q=a[3],u=b[0],w=b[1],A=b[2],C=b[3],D=1/(C*C+u*u+w*w+A*A);a[0]=(g*C-q*u-n*A+p*w)*D;a[1]=(g*A-q*w+n*C-p*u)*D;a[2]=(n*u+p*C-q*A-g*w)*D;a[3]=(q*C+g*u+n*w+p*A)*D;return a},invert:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];var p=1/(b*b+g*g+n*n+a*a);return new B(-b*p,-g*p,-n*p,a*p)},$invert:function(a){var b=a[0],g=a[1],n=a[2],p=a[3],q=1/(b*b+g*g+n*n+p*p);a[0]=-b*q;a[1]=-g*q;a[2]=-n*q;
a[3]=p*q;return a},norm:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return y(b*b+g*g+n*n+a*a)},normSq:function(a){var b=a[0],g=a[1],n=a[2];a=a[3];return b*b+g*g+n*n+a*a},unit:function(a){return B.scale(a,1/B.norm(a))},$unit:function(a){return B.$scale(a,1/B.norm(a))},conjugate:function(a){return new B(-a[0],-a[1],-a[2],a[3])},$conjugate:function(a){a[0]=-a[0];a[1]=-a[1];a[2]=-a[2];return a}};s=B.prototype={};for(z in m){B[z]=m[z];s[z]=function(a){return function(){var b=h.call(arguments);b.unshift(this);
return B[a].apply(B,b)}}(z)}i.fromQuat=function(a){return new i(a[0],a[1],a[2])};B.fromVec3=function(a,b){return new B(a[0],a[1],a[2],b||0)};B.fromMat4=function(a){var b,g,n;if(a[0]>a[5]&&a[0]>a[10]){b=0;g=1;n=2}else if(a[5]>a[0]&&a[5]>a[10]){b=1;g=2;n=0}else{b=2;g=0;n=1}var p=y(1+a[b*5]-a[g*5]-a[n*5]),q=new B;q[b]=0.5*p;q[g]=0.5*(a["n"+g+""+b]+a["n"+b+""+g])/p;q[n]=0.5*(a["n"+b+""+n]+a["n"+n+""+b])/p;q[3]=0.5*(a["n"+g+""+n]-a["n"+n+""+g])/p;return q};B.fromXRotation=function(a){return new B(r(a/
2),0,0,l(a/2))};B.fromYRotation=function(a){return new B(0,r(a/2),0,l(a/2))};B.fromZRotation=function(a){return new B(0,0,r(a/2),l(a/2))};B.fromAxisRotation=function(a,b){var g=a[0],n=a[1],p=a[2],q=1/y(g*g+n*n+p*p),u=r(b/2),w=l(b/2);return new B(u*g*q,u*n*q,u*p*q,w)};t.fromQuat=function(a){var b=a[3],g=a[0],n=a[1];a=a[2];return new t(b*b+g*g-n*n-a*a,2*g*n-2*b*a,2*g*a+2*b*n,0,2*g*n+2*b*a,b*b-g*g+n*n-a*a,2*n*a-2*b*g,0,2*g*a-2*b*n,2*n*a+2*b*g,b*b-g*g-n*n+a*a,0,0,0,0,1)};PhiloGL.Vec3=i;PhiloGL.Mat4=t;
PhiloGL.Quat=B})();(function(){function x(f){return f!==true?f:false}var y=function(f){f=f.getBoundingClientRect();return{x:f.left,y:f.top,bbox:f}},r={get:function(f,h){return f||(h||window).event},getWheel:function(f){return f.wheelDelta?f.wheelDelta/120:-(f.detail||0)/3},getKey:function(f){var h=f.which||f.keyCode,j;a:{j=d.Keys;for(var c in j)if(j[c]==h){j=c;break a}j=void 0}c=h-111;if(c>0&&c<13)j="f"+c;j=j||String.fromCharCode(h).toLowerCase();return{code:h,key:j,shift:f.shiftKey,control:f.ctrlKey,
alt:f.altKey,meta:f.metaKey}},isRightClick:function(f){return f.which==3||f.button==2},getPos:function(f,h){h=h||window;f=f||h.event;var j=h.document;j=j.documentElement||j.body;if(f.touches&&f.touches.length)f=f.touches[0];return{x:f.pageX||f.clientX+j.scrollLeft,y:f.pageY||f.clientY+j.scrollTop}},stop:function(f){f.stopPropagation&&f.stopPropagation();f.cancelBubble=true;if(f.preventDefault)f.preventDefault();else f.returnValue=false}},l=function(f,h){var j=f.canvas;this.scene=f.scene;this.domElem=
j;this.pos=y(j);this.opt=this.callbacks=h;this.size={width:j.width||j.offsetWidth,height:j.height||j.offsetHeight};this.attachEvents()};l.prototype={hovered:false,pressed:false,touched:false,touchMoved:false,moved:false,attachEvents:function(){var f=this.domElem,h=this;if(this.opt.disableContextMenu)f.oncontextmenu=function(){return false};["mouseup","mousedown","mousemove","mouseover","mouseout","touchstart","touchmove","touchend"].forEach(function(c){f.addEventListener(c,function(k,i){h[c](h.eventInfo(c,
k,i))},false)});["keydown","keyup"].forEach(function(c){document.addEventListener(c,function(k,i){h[c](h.eventInfo(c,k,i))},false)});var j="";j=!document.getBoxObjectFor&&window.mozInnerScreenX==null?"mousewheel":"DOMMouseScroll";f.addEventListener(j,function(c,k){h.mousewheel(h.eventInfo("mousewheel",c,k))},false)},eventInfo:function(f,h,j){var c=this.domElem,k=this.scene,i=this.opt,m=this.getSize(),s=i.relative,z=i.centerOrigin,t=i.cachePosition&&this.pos||y(c),B=r.get(h,j),a=r.getPos(h,j);h={};
j=a.x;c=a.y;if(s){j-=t.x;c-=t.y;if(z){j-=m.width/2;c-=m.height/2;c*=-1}}switch(f){case "mousewheel":h.wheel=r.getWheel(B);break;case "keydown":case "keyup":v.extend(h,r.getKey(B));break;case "mouseup":h.isRightClick=r.isRightClick(B)}var b;v.extend(h,{x:j,y:c,cache:false,stop:function(){r.stop(B)},getTarget:function(){if(b)return b;return b=!i.picking||k.pick(a.x-t.x,a.y-t.y,i.lazyPicking)||true}});h.event=B;return h},getSize:function(){if(this.cacheSize)return this.size;var f=this.domElem;return{width:f.width||
f.offsetWidth,height:f.height||f.offsetHeight}},mouseup:function(f){if(!this.moved)if(f.isRightClick)this.callbacks.onRightClick(f,this.hovered);else this.callbacks.onClick(f,x(this.pressed));if(this.pressed){if(this.moved)this.callbacks.onDragEnd(f,x(this.pressed));else this.callbacks.onDragCancel(f,x(this.pressed));this.pressed=this.moved=false}},mouseout:function(f){for(var h=f.relatedTarget,j=this.domElem;h&&h.parentNode;){if(j==h.parentNode)return;h=h.parentNode}if(this.hovered){this.callbacks.onMouseLeave(f,
this.hovered);this.hovered=false}if(this.pressed&&this.moved){this.callbacks.onDragEnd(f);this.pressed=this.moved=false}},mouseover:function(){},mousemove:function(f){if(this.pressed){this.moved=true;this.callbacks.onDragMove(f,x(this.pressed))}else{if(this.hovered){var h=x(f.getTarget());if(!h||h.hash!=this.hash){this.callbacks.onMouseLeave(f,this.hovered);if(this.hash=this.hovered=h){this.hash=h.hash;this.callbacks.onMouseEnter(f,this.hovered)}}else this.callbacks.onMouseMove(f,this.hovered)}else if(this.hash=
this.hovered=x(f.getTarget())){this.hash=this.hovered.hash;this.callbacks.onMouseEnter(f,this.hovered)}if(!this.opt.picking)this.callbacks.onMouseMove(f)}},mousewheel:function(f){this.callbacks.onMouseWheel(f)},mousedown:function(f){this.pressed=f.getTarget();this.callbacks.onDragStart(f,x(this.pressed))},touchstart:function(f){this.touched=f.getTarget();this.callbacks.onTouchStart(f,x(this.touched))},touchmove:function(f){if(this.touched){this.touchMoved=true;this.callbacks.onTouchMove(f,x(this.touched))}},
touchend:function(f){if(this.touched){if(this.touchMoved)this.callbacks.onTouchEnd(f,x(this.touched));else this.callbacks.onTouchCancel(f,x(this.touched));this.touched=this.touchMoved=false}},keydown:function(f){this.callbacks.onKeyDown(f)},keyup:function(f){this.callbacks.onKeyUp(f)}};var d={};d.create=function(f,h){h=v.extend({cachePosition:true,cacheSize:true,relative:true,centerOrigin:true,disableContextMenu:true,bind:false,picking:false,lazyPicking:false,onClick:v.empty,onRightClick:v.empty,
onDragStart:v.empty,onDragMove:v.empty,onDragEnd:v.empty,onDragCancel:v.empty,onTouchStart:v.empty,onTouchMove:v.empty,onTouchEnd:v.empty,onTouchCancel:v.empty,onMouseMove:v.empty,onMouseEnter:v.empty,onMouseLeave:v.empty,onMouseWheel:v.empty,onKeyDown:v.empty,onKeyUp:v.empty},h||{});var j=h.bind;if(j)for(var c in h)c.match(/^on[a-zA-Z0-9]+$/)&&function(k,i){h[k]=function(){return i.apply(j,Array.prototype.slice.call(arguments))}}(c,h[c]);new l(f,h);f.events=h};d.Keys={enter:13,up:38,down:40,left:37,
right:39,esc:27,space:32,backspace:8,tab:9,"delete":46};PhiloGL.Events=d})();(function(){function x(){return arguments.length==2?{vs:arguments[0],fs:arguments[1]}:arguments[0]||{}}var y=function(d,f,h){var j=d.createShader(h);if(j==null)throw"Error creating the shader with shader type: "+h;d.shaderSource(j,f);d.compileShader(j);if(!d.getShaderParameter(j,d.COMPILE_STATUS)){f=d.getShaderInfoLog(j);d.deleteShader(j);throw"Error while compiling the shader "+f;}return j},r=function(d,f,h){var j=o.getUniformLocation(d,
f.name);d=f.type;var c=false,k=true,i,m;if(f.size>1&&h)switch(d){case o.FLOAT:i=o.uniform1fv;m=Float32Array;k=false;break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:i=o.uniform1iv;m=Uint16Array;k=false}if(k)switch(d){case o.FLOAT:i=o.uniform1f;break;case o.FLOAT_VEC2:i=o.uniform2fv;m=h?Float32Array:new Float32Array(2);break;case o.FLOAT_VEC3:i=o.uniform3fv;m=h?Float32Array:new Float32Array(3);break;case o.FLOAT_VEC4:i=o.uniform4fv;m=h?Float32Array:new Float32Array(4);break;case o.INT:case o.BOOL:case o.SAMPLER_2D:case o.SAMPLER_CUBE:i=
o.uniform1i;break;case o.INT_VEC2:case o.BOOL_VEC2:i=o.uniform2iv;m=h?Uint16Array:new Uint16Array(2);break;case o.INT_VEC3:case o.BOOL_VEC3:i=o.uniform3iv;m=h?Uint16Array:new Uint16Array(3);break;case o.INT_VEC4:case o.BOOL_VEC4:i=o.uniform4iv;m=h?Uint16Array:new Uint16Array(4);break;case o.FLOAT_MAT2:c=true;i=o.uniformMatrix2fv;break;case o.FLOAT_MAT3:c=true;i=o.uniformMatrix3fv;break;case o.FLOAT_MAT4:c=true;i=o.uniformMatrix4fv}if(i.bind)i=i.bind(o);else{var s=i;i=function(){s.apply(o,arguments)}}return h&&
m?function(z){i(j,new m(z))}:c?function(z){i(j,false,z.toFloat32Array())}:m?function(z){m.set(z);i(j,m)}:function(z){i(j,z)};throw"Unknown type: "+d;},l=function(d,f){var h=o,j=h.createProgram();h.attachShader(j,y(h,d,h.VERTEX_SHADER));h.attachShader(j,y(h,f,h.FRAGMENT_SHADER));h.linkProgram(j);if(!h.getProgramParameter(j,h.LINK_STATUS))throw"Error linking the shader: "+h.getProgramInfoLog(j);if(!j)return false;h={};for(var c={},k,i,m=o.getProgramParameter(j,o.ACTIVE_ATTRIBUTES),s=0;s<m;s++){k=o.getActiveAttrib(j,
s);i=k.name;k=o.getAttribLocation(j,k.name);h[i]=k}m=o.getProgramParameter(j,o.ACTIVE_UNIFORMS);for(s=0;s<m;s++){k=o.getActiveUniform(j,s);i=k.name;i=i[i.length-1]=="]"?i.substr(0,i.length-3):i;c[i]=r(j,k,k.name!=i)}this.program=j;this.attributes=h;this.attributeEnabled={};this.uniforms=c};l.prototype={$$family:"program",setUniform:function(d,f){if(this.uniforms[d])this.uniforms[d](f);return this},setUniforms:function(d){for(var f in d)this.setUniform(f,d[f]);return this}};["setBuffer","setBuffers",
"use"].forEach(function(d){l.prototype[d]=function(){var f=Array.prototype.slice.call(arguments);f.unshift(this);M[d].apply(M,f);return this}});["setFrameBuffer","setFrameBuffers","setRenderBuffer","setRenderBuffers","setTexture","setTextures"].forEach(function(d){l.prototype[d]=function(){M[d].apply(M,arguments);return this}});l.fromShaderIds=function(){var d=x.apply({},arguments),f=v(d.vs);d=v(d.fs);return new l(f.innerHTML,d.innerHTML)};l.fromShaderSources=function(){var d=x.apply({},arguments);
return new l(d.vs,d.fs)};l.fromDefaultShaders=function(){var d=x.apply({},arguments),f=PhiloGL.Shaders;return PhiloGL.Program.fromShaderSources(f.Vertex[d.vs||"Default"],f.Fragment[d.fs||"Default"])};l.fromShaderURIs=function(d){d=v.merge({path:"",vs:"",fs:"",noCache:false,onSuccess:v.empty,onError:v.empty},d||{});(new PhiloGL.IO.XHR.Group({urls:[d.path+d.vs,d.path+d.fs],noCache:d.noCache,onError:function(f){d.onError(f)},onComplete:function(f){try{var h=l.fromShaderSources(f[0],f[1]);d.onSuccess(h,
d)}catch(j){d.onError(j,d)}}})).send()};PhiloGL.Program=l})();(function(){var x={},y=function(d){this.opt=d=v.merge({url:"http://philogljs.org/",method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false,onProgress:v.empty,onSuccess:v.empty,onError:v.empty,onAbort:v.empty,onComplete:v.empty},d||{});this.initXHR()};y.State={};["UNINITIALIZED","LOADING","LOADED","INTERACTIVE","COMPLETED"].forEach(function(d,f){y.State[d]=f});y.prototype={initXHR:function(){var d=this.req=new XMLHttpRequest,
f=this;["Progress","Error","Abort","Load"].forEach(function(h){if(d.addEventListener)d.addEventListener(h.toLowerCase(),function(j){f["handle"+h](j)},false);else d["on"+h.toLowerCase()]=function(j){f["handle"+h](j)}})},send:function(d){var f=this.req,h=this.opt,j=h.async;if(h.noCache)h.url+=(h.url.indexOf("?")>=0?"&":"?")+v.uid();f.open(h.method,h.url,j);if(h.responseType)f.responseType=h.responseType;if(j)f.onreadystatechange=function(){if(f.readyState==y.State.COMPLETED)if(f.status==200)h.onSuccess(f.responseType?
f.response:f.responseText);else h.onError(f.status)};h.sendAsBinary?f.sendAsBinary(d||h.body||null):f.send(d||h.body||null);if(!j)if(f.status==200)h.onSuccess(f.responseType?f.response:f.responseText);else h.onError(f.status)},setRequestHeader:function(d,f){this.req.setRequestHeader(d,f);return this},handleProgress:function(d){if(d.lengthComputable)this.opt.onProgress(d,Math.round(d.loaded/d.total*100));else this.opt.onProgress(d,-1)},handleError:function(d){this.opt.onError(d)},handleAbort:function(){this.opt.onAbort(e)},
handleLoad:function(d){this.opt.onComplete(d)}};y.Group=function(d){function f(i){return function(m){--c;d.onError(m,i);if(!c)d.onComplete(k)}}function h(i){return function(m){--c;k[i]=m;d.onSuccess(m,i);if(!c)d.onComplete(k)}}d=v.merge({urls:[],onError:v.empty,onSuccess:v.empty,onComplete:v.empty,method:"GET",async:true,noCache:false,sendAsBinary:false,responseType:false},d||{});var j=v.splat(d.urls),c=j.length,k=Array(c);this.reqs=j.map(function(i,m){return new y({url:i,method:d.method,async:d.async,
noCache:d.noCache,sendAsBinary:d.sendAsBinary,responseType:d.responseType,body:d.body,onError:f(m),onSuccess:h(m)})})};y.Group.prototype={send:function(){for(var d=0,f=this.reqs,h=f.length;d<h;++d)f[d].send()}};var r=function(d){d=v.merge({url:"http://philogljs.org/",data:{},noCache:false,onComplete:v.empty,callbackKey:"callback"},d||{});var f=r.counter++,h=[],j;for(j in d.data)h.push(j+"="+d.data[j]);h=h.join("&");if(d.noCache)h+=(h.indexOf("?")>=0?"&":"?")+v.uid();h=d.url+(d.url.indexOf("?")>-1?
"&":"?")+d.callbackKey+"=PhiloGL.IO.JSONP.requests.request_"+f+(h.length>0?"&"+h:"");var c=document.createElement("script");c.type="text/javascript";c.src=h;r.requests["request_"+f]=function(k){d.onComplete(k);c.parentNode&&c.parentNode.removeChild(c);c.clearAttributes&&c.clearAttributes()};document.getElementsByTagName("head")[0].appendChild(c)};r.counter=0;r.requests={};var l=function(d){d=v.merge({src:[],noCache:false,onProgress:v.empty,onComplete:v.empty},d||{});var f=0,h=d.src.length,j=function(){d.onProgress(Math.round(++f/
h*100));if(f==h)d.onComplete(m)},c=function(){if(++f==h)d.onComplete(m)},k=d.noCache,i=v.uid(),m=d.src.map(function(s,z){var t=new Image;t.index=z;t.onload=j;t.onerror=c;t.src=s+(k?(s.indexOf("?")>=0?"&":"?")+i:"");return t});return m};x.XHR=y;x.JSONP=r;x.Images=l;x.Textures=function(d){d=v.merge({src:[],noCache:false,onComplete:v.empty},d||{});l({src:d.src,noCache:d.noCache,onComplete:function(f){var h={};f.forEach(function(j,c){h[d.src[c]]=v.merge({data:{value:j}},d)});M.setTextures(h);d.onComplete()}})};
PhiloGL.IO=x})();(function(){var x=PhiloGL.Vec3,y=PhiloGL.Mat4,r=function(l,d,f,h,j){j=j||{};var c=j.position,k=j.target,i=j.up;this.type=j.type?j.type:"perspective";this.fov=l;this.near=f;this.far=h;this.aspect=d;this.position=c&&new x(c.x,c.y,c.z)||new x;this.target=k&&new x(k.x,k.y,k.z)||new x;this.up=i&&new x(i.x,i.y,i.z)||new x(0,1,0);if(this.type=="perspective")this.projection=(new y).perspective(l,d,f,h);else{l=f*Math.tan(l*Math.PI/360);j=-l;this.projection=(new y).ortho(j*d,l*d,j,l,f,h)}this.view=
new y};r.prototype={update:function(){if(this.type=="perspective")this.projection=(new y).perspective(this.fov,this.aspect,this.near,this.far);else{var l=this.near*Math.tan(this.fov*Math.PI/360),d=-l,f=d*this.aspect,h=l*this.aspect;this.projection=(new y).ortho(f,h,d,l,this.near,this.far)}this.view.lookAt(this.position,this.target,this.up)}};PhiloGL.Camera=r})();(function(){function x(c,k){if(c&&c.length<k){for(var i=c[0],m=c[1],s=c[2],z=c[3],t=[i,m,s,z],B=k/c.length,a;--B;){a=B*4;t[a]=i;t[a+1]=m;
t[a+2]=s;t[a+3]=z}return new Float32Array(t)}else return c}var y=PhiloGL.Vec3,r=PhiloGL.Mat4,l=Math.cos,d=Math.sin,f=Math.PI,h=Array.prototype.slice,j={attributeMap:{position:"vertices",normal:"normals",pickingColor:"pickingColors",colors:"color"}};j.Model=function(c){c=c||{};this.id=c.id||v.uid();this.pickable=!!c.pickable;this.pick=c.pick||function(){return false};this.vertices=c.vertices;this.normals=c.normals;this.textures=c.textures&&v.splat(c.textures);this.colors=c.colors;this.indices=c.indices;
this.shininess=c.shininess||0;this.reflection=c.reflection||0;this.refraction=c.refraction||0;if(c.pickingColors)this.pickingColors=c.pickingColors;if(c.texCoords)this.texCoords=c.texCoords;this.uniforms=c.uniforms||{};this.attributes=c.attributes||{};this.render=c.render;this.drawType=c.drawType||"TRIANGLES";this.display="display"in c?c.display:true;this.onBeforeRender=c.onBeforeRender||v.empty;this.onAfterRender=c.onAfterRender||v.empty;if(c.program)this.program=c.program;this.position=new y;this.rotation=
new y;this.scale=new y(1,1,1);this.matrix=new r;c.computeCentroids&&this.computeCentroids();c.computeNormals&&this.computeNormals()};j.Model.prototype=Object.create(null,{hash:{get:function(){return this.id+" "+this.$pickingIndex}},vertices:{set:function(c){if(c){var k=c.length;if(c.BYTES_PER_ELEMENT)this.$vertices=c;else if(this.$verticesLength==k)this.$vertices.set(c);else this.$vertices=new Float32Array(c);this.$verticesLength=k}else{delete this.$vertices;delete this.$verticesLength}},get:function(){return this.$vertices}},
normals:{set:function(c){if(c){var k=c.length;if(c.BYTES_PER_ELEMENT)this.$normals=c;else if(this.$normalsLength==k)this.$normals.set(c);else this.$normals=new Float32Array(c);this.$normalsLength=k}else{delete this.$normals;delete this.$normalsLength}},get:function(){return this.$normals}},colors:{set:function(c){if(c){var k=c.length;if(c.BYTES_PER_ELEMENT)this.$colors=c;else if(this.$colorsLength==k)this.$colors.set(c);else this.$colors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/
3*4!=k)this.$colors=x(h.call(this.$colors),this.$verticesLength/3*4);this.$colorsLength=this.$colors.length}else{delete this.$colors;delete this.$colorsLength}},get:function(){return this.$colors}},pickingColors:{set:function(c){if(c){var k=c.length;if(c.BYTES_PER_ELEMENT)this.$pickingColors=c;else if(this.$pickingColorsLength==k)this.$pickingColors.set(c);else this.$pickingColors=new Float32Array(c);if(this.$vertices&&this.$verticesLength/3*4!=k)this.$pickingColors=x(h.call(this.$pickingColors),
this.$verticesLength/3*4);this.$pickingColorsLength=this.$pickingColors.length}else{delete this.$pickingColors;delete this.$pickingColorsLength}},get:function(){return this.$pickingColors}},texCoords:{set:function(c){if(c)if(v.type(c)=="object"){var k={},i;for(i in c){var m=c[i];k[i]=m.BYTES_PER_ELEMENT?m:new Float32Array(m)}this.$texCoords=k}else{k=c.length;if(c.BYTES_PER_ELEMENT)this.$texCoords=c;else if(this.$texCoordsLength==k)this.$texCoords.set(c);else this.$texCoords=new Float32Array(c);this.$texCoordsLength=
k}else{delete this.$texCoords;delete this.$texCoordsLength}},get:function(){return this.$texCoords}},indices:{set:function(c){if(c){var k=c.length;if(c.BYTES_PER_ELEMENT)this.$indices=c;else if(this.$indicesLength==k)this.$indices.set(c);else this.$indices=new Uint16Array(c);this.$indicesLength=k}else{delete this.$indices;delete this.$indicesLength}},get:function(){return this.$indices}}});v.extend(j.Model.prototype,{$$family:"model",update:function(){var c=this.matrix,k=this.position,i=this.rotation,
m=this.scale;c.id();c.$translate(k.x,k.y,k.z);c.$rotateXYZ(i.x,i.y,i.z);c.$scale(m.x,m.y,m.z)},computeCentroids:function(){var c=this.vertices,k=[];this.faces.forEach(function(i){var m=[0,0,0],s=0;i.forEach(function(z){z=c[z];m[0]+=z[0];m[1]+=z[1];m[2]+=z[2];s++});m[0]/=s;m[1]/=s;m[2]/=s;k.push(m)});this.centroids=k},computeNormals:function(){var c=this.vertices,k=[];this.faces.forEach(function(i){var m=c[i[0]],s=c[i[1]];i=c[i[2]];m={x:m[0]-s[0],y:m[1]-s[1],z:m[2]-s[2]};y.$cross(m,{x:i[0]-s[0],y:i[1]-
s[1],z:i[1]-s[2]});y.norm(m)>1.0E-6&&y.unit(m);k.push([m.x,m.y,m.z])});this.normals=k}});v.extend(j.Model.prototype,{setUniforms:function(c){c.setUniforms(this.uniforms)},setAttributes:function(c){var k=this.attributes,i;for(i in k){var m=k[i],s=this.id+"-"+i;if(Object.keys(m).length){m.attribute=i;c.setBuffer(s,m);delete m.value}else c.setBuffer(s,true)}},setVertices:function(c){if(this.$vertices)this.dynamic?c.setBuffer("position-"+this.id,{attribute:"position",value:this.$vertices,size:3}):c.setBuffer("position-"+
this.id)},setNormals:function(c){if(this.$normals)this.dynamic?c.setBuffer("normal-"+this.id,{attribute:"normal",value:this.$normals,size:3}):c.setBuffer("normal-"+this.id)},setIndices:function(c){if(this.$indices)this.dynamic?c.setBuffer("indices-"+this.id,{bufferType:o.ELEMENT_ARRAY_BUFFER,drawType:o.STATIC_DRAW,value:this.$indices,size:1}):c.setBuffer("indices-"+this.id)},setPickingColors:function(c){if(this.$pickingColors)this.dynamic?c.setBuffer("pickingColor-"+this.id,{attribute:"pickingColor",
value:this.$pickingColors,size:4}):c.setBuffer("pickingColor-"+this.id)},setColors:function(c){if(this.$colors)this.dynamic?c.setBuffer("color-"+this.id,{attribute:"color",value:this.$colors,size:4}):c.setBuffer("color-"+this.id)},setTexCoords:function(c){if(this.$texCoords){var k=this.id,i,m,s,z;if(this.dynamic)if(v.type(this.$texCoords)=="object"){i=0;m=this.textures;for(s=m.length;i<s;i++){z=m[i];c.setBuffer("texCoord-"+i+"-"+k,{attribute:"texCoord"+(i+1),value:this.$texCoords[z],size:2})}}else c.setBuffer("texCoord-"+
k,{attribute:"texCoord1",value:this.$texCoords,size:2});else if(v.type(this.$texCoords)=="object"){i=0;m=this.textures;for(s=m.length;i<s;i++)c.setBuffer("texCoord-"+i+"-"+k)}else c.setBuffer("texCoord-"+k)}},setTextures:function(c){this.textures=this.textures?v.splat(this.textures):[];for(var k=0,i=this.textures,m=i.length,s=PhiloGL.Scene.MAX_TEXTURES;k<s;k++){if(k<m)if(M.textureMemo[i[k]].isCube){c.setUniform("hasTextureCube"+(k+1),true);c.setTexture(i[k],o["TEXTURE"+(k+5)])}else{c.setUniform("hasTexture"+
(k+1),true);c.setTexture(i[k],o["TEXTURE"+k])}else{c.setUniform("hasTextureCube"+(k+1),false);c.setUniform("hasTexture"+(k+1),false)}c.setUniform("sampler"+(k+1),k);c.setUniform("samplerCube"+(k+1),k+5)}},setState:function(c){this.setUniforms(c);this.setAttributes(c);this.setVertices(c);this.setColors(c);this.setPickingColors(c);this.setNormals(c);this.setTextures(c);this.setTexCoords(c);this.setIndices(c)},unsetState:function(c){c=c.attributes;o.bindBuffer(o.ARRAY_BUFFER,null);o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,
null);for(var k in c)o.disableVertexAttribArray(c[k])}});j.Cube=function(c){j.Model.call(this,v.extend({vertices:[-1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,-1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,1,-1,1,1,-1,1,-1],texCoords:[0,0,1,0,1,1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1,0,1,1,1,1,0,1,0,0,1,0,1,0,1,1,0,1,0,0,0,0,1,0,1,1,0,1],normals:[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,
0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},c||{}))};j.Cube.prototype=Object.create(j.Model.prototype);j.Sphere=function(c){var k=c.nlat||10,i=c.nlong||10,m=c.radius||1,s=f-0,z=2*f-0,t=(k+1)*(i+1),B=new Float32Array(t*3),a=new Float32Array(t*3);t=new Float32Array(t*2);var b=new Uint16Array(k*i*6);if(typeof m=="number"){var g=m;m=function(){return g}}for(var n=0;n<=k;n++)for(var p=
0;p<=i;p++){var q=p/i,u=n/k,w=z*q,A=s*u,C=d(w);w=l(w);var D=d(A),E=l(A);A=w*D;w=E;C*=D;D=m(A,w,C,q,u);E=p+n*(i+1);var G=E*3;E*=2;B[G+0]=D*A;B[G+1]=D*w;B[G+2]=D*C;a[G+0]=A;a[G+1]=w;a[G+2]=C;t[E+0]=q;t[E+1]=u}m=k+1;for(p=0;p<k;p++)for(n=0;n<i;n++){E=(p*i+n)*6;b[E+0]=n*m+p;b[E+1]=n*m+p+1;b[E+2]=(n+1)*m+p;b[E+3]=(n+1)*m+p;b[E+4]=n*m+p+1;b[E+5]=(n+1)*m+p+1}j.Model.call(this,v.extend({vertices:B,indices:b,normals:a,texCoords:t},c||{}))};j.Sphere.prototype=Object.create(j.Model.prototype);j.IcoSphere=function(c){var k=
c.iterations||0,i=[],m=[],s=Math.sqrt,z=Math.acos,t=Math.atan2,B=Math.PI,a=B*2;c.onAddVertex=c.onAddVertex||v.empty;var b=(1+s(5))/2,g=s(1+b*b);i.push(-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,0,0,-1/g,b/g,0,1/g,b/g,0,-1/g,-b/g,0,1/g,-b/g,b/g,0,-1/g,b/g,0,1/g,-b/g,0,-1/g,-b/g,0,1/g);m.push(0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1);var n=function(){var W={};return function(S,T){S*=3;T*=3;var X=(S<T?S:T)+"|"+(S>
T?S:T);if(X in W)return W[X];var O=(i[S]+i[T])/2,Y=(i[S+1]+i[T+1])/2,Z=(i[S+2]+i[T+2])/2,$=s(O*O+Y*Y+Z*Z);O/=$;Y/=$;Z/=$;i.push(O,Y,Z);return W[X]=i.length/3-1}}();for(b=0;b<k;b++){var p=[],q=0;for(g=m.length;q<g;q+=3){var u=n(m[q],m[q+1]),w=n(m[q+1],m[q+2]),A=n(m[q+2],m[q]);p.push(m[q],u,A,m[q+1],w,u,m[q+2],A,w,u,w,A)}m=p}g=m.length;k=new Float32Array(g*3);n=new Float32Array(g*2);for(b=0;b<g;b+=3){w=m[b];A=m[b+1];var C=m[b+2];p=w*3;q=A*3;u=C*3;w*=2;A*=2;C*=2;var D=i[p],E=i[p+1],G=i[p+2],I=z(G/s(D*
D+E*E+G*G)),J=t(E,D);I/=B;J=1-J/a;var H=i[q],F=i[q+1],N=i[q+2],K=z(N/s(H*H+F*F+N*N)),L=t(F,H);K/=B;L=1-L/a;var P=i[u],Q=i[u+1],R=i[u+2],U=z(R/s(P*P+Q*Q+R*R)),V=t(Q,P);U/=B;V=1-V/a;D=y.cross({x:P-H,y:Q-F,z:R-N},{x:D-H,y:E-F,z:G-N}).$unit();k[p]=k[q]=k[u]=D.x;k[p+1]=k[q+1]=k[u+1]=D.y;k[p+2]=k[q+2]=k[u+2]=D.z;n[w]=J;n[w+1]=I;n[A]=L;n[A+1]=K;n[C]=V;n[C+1]=U}j.Model.call(this,v.extend({vertices:i,indices:m,normals:k,texCoords:n},c||{}))};j.IcoSphere.prototype=Object.create(j.Model.prototype);j.TruncatedCone=
function(c){var k=c.bottomRadius||0,i=c.topRadius||0,m=c.height||1,s=c.nradial||10,z=c.nvertical||10,t=!!c.topCap,B=!!c.bottomCap,a=(t?2:0)+(B?2:0),b=(s+1)*(z+1+a),g=new Float32Array(b*3),n=new Float32Array(b*3);b=new Float32Array(b*2);var p=new Uint16Array(s*(z+a)*6),q=s+1,u=Math,w=u.atan2(k-i,m),A=u.sin,C=u.cos;u=u.PI;var D=C(w);w=A(w);B=z+(B?2:0);var E=0,G=0;for(t=t?-2:0;t<=B;t++){var I=t/z,J=m*I,H;if(t<0){J=0;I=1;H=k}else if(t>z){J=m;I=1;H=i}else H=k+(i-k)*(t/z);if(t==-2||t==z+2)I=H=0;J-=m/2;
for(var F=0;F<q;F++){var N=A(F*u*2/s),K=C(F*u*2/s);g[E+0]=N*H;g[E+1]=J;g[E+2]=K*H;n[E+0]=t<0||t>z?0:N*D;n[E+1]=t<0?-1:t>z?1:w;n[E+2]=t<0||t>z?0:K*D;b[G+0]=F/s;b[G+1]=I;G+=2;E+=3}}for(t=0;t<z+a;t++)for(F=0;F<s;F++){k=(t*s+F)*6;p[k+0]=q*(t+0)+0+F;p[k+1]=q*(t+0)+1+F;p[k+2]=q*(t+1)+1+F;p[k+3]=q*(t+0)+0+F;p[k+4]=q*(t+1)+1+F;p[k+5]=q*(t+1)+0+F}j.Model.call(this,v.extend({vertices:g,normals:n,texCoords:b,indices:p},c||{}))};j.TruncatedCone.prototype=Object.create(j.Model.prototype);j.Cone=function(c){c.topRadius=
0;c.topCap=!!c.cap;c.bottomCap=!!c.cap;c.bottomRadius=c.radius||3;j.TruncatedCone.call(this,c)};j.Cone.prototype=Object.create(j.TruncatedCone.prototype);j.Cylinder=function(c){c.bottomRadius=c.radius;c.topRadius=c.radius;j.TruncatedCone.call(this,c)};j.Cylinder.prototype=Object.create(j.TruncatedCone.prototype);j.Plane=function(c){var k=c.type,i=k.split(","),m=c[i[0]+"len"],s=c[i[1]+"len"],z=c["n"+i[0]]||1;i=c["n"+i[1]]||1;var t=c.offset,B=!!c.flipCull,a=(z+1)*(i+1),b=new Float32Array(a*3),g=new Float32Array(a*
3);a=new Float32Array(a*2);var n=0,p=0;if(B)m=-m;for(var q=0;q<=i;q++)for(var u=0;u<=z;u++){var w=u/z,A=q/i;a[n+0]=B?1-w:w;a[n+1]=A;n+=2;switch(k){case "x,y":b[p+0]=m*w-m*0.5;b[p+1]=s*A-s*0.5;b[p+2]=t;g[p+0]=0;g[p+1]=0;g[p+2]=B?1:-1;break;case "x,z":b[p+0]=m*w-m*0.5;b[p+1]=t;b[p+2]=s*A-s*0.5;g[p+0]=0;g[p+1]=B?1:-1;g[p+2]=0;break;case "y,z":b[p+0]=t;b[p+1]=m*w-m*0.5;b[p+2]=s*A-s*0.5;g[p+0]=B?1:-1;g[p+1]=0;g[p+2]=0}p+=3}k=z+1;m=[];for(q=0;q<i;q++)for(u=0;u<z;u++){s=(q*z+u)*6;m[s+0]=(q+0)*k+u;m[s+1]=
(q+1)*k+u;m[s+2]=(q+0)*k+u+1;m[s+3]=(q+1)*k+u;m[s+4]=(q+1)*k+u+1;m[s+5]=(q+0)*k+u+1}j.Model.call(this,v.extend({vertices:b,normals:g,texCoords:a,indices:m},c))};j.Plane.prototype=Object.create(j.Model.prototype);j.id=v.time();PhiloGL.O3D=j})();(function(){var x={Vertex:{},Fragment:{}},y=x.Fragment;x.Vertex.Default="#define LIGHT_MAX 40\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color;\nattribute vec4 pickingColor;\nattribute vec2 texCoord1;\nuniform mat4 viewMatrix;\nuniform mat4 viewInverseMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewProjectionMatrix;\nuniform mat4 worldMatrix;\nuniform mat4 worldInverseMatrix;\nuniform mat4 worldInverseTransposeMatrix;\nuniform mat4 objectMatrix;\nuniform vec3 cameraPosition;\nuniform bool enableLights;\nuniform vec3 ambientColor;\nuniform vec3 directionalColor;\nuniform vec3 lightingDirection;\nuniform vec3 pointLocation[LIGHT_MAX];\nuniform vec3 pointColor[LIGHT_MAX];\nuniform int numberPoints;\nuniform bool useReflection;\nvarying vec3 vReflection;\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec4 vNormal;\nvarying vec3 lightWeighting;\nvoid main(void) {\nvec4 mvPosition = worldMatrix * vec4(position, 1.0);\nvec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);\nif(!enableLights) {\nlightWeighting = vec3(1.0, 1.0, 1.0);\n} else {\nvec3 plightDirection;\nvec3 pointWeight = vec3(0.0, 0.0, 0.0);\nfloat directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);\nfor (int i = 0; i < LIGHT_MAX; i++) {\nif (i < numberPoints) {\nplightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);\npointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];\n} else {\nbreak;\n}\n}\nlightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;\n}\nif (useReflection) {\nvReflection = (viewInverseMatrix[3] - (worldMatrix * vec4(position, 1.0))).xyz;\n} else {\nvReflection = vec3(1.0, 1.0, 1.0);\n}\nvColor = color;\nvPickingColor = pickingColor;\nvTexCoord = texCoord1;\nvNormal = transformedNormal;\ngl_Position = projectionMatrix * worldMatrix * vec4(position, 1.0);\n}";
y.Default="#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 vColor;\nvarying vec4 vPickingColor;\nvarying vec2 vTexCoord;\nvarying vec3 lightWeighting;\nvarying vec3 vReflection;\nvarying vec4 vNormal;\nuniform bool hasTexture1;\nuniform sampler2D sampler1;\nuniform bool hasTextureCube1;\nuniform samplerCube samplerCube1;\nuniform bool enablePicking;\nuniform bool hasPickingColors;\nuniform vec3 pickColor;\nuniform float reflection;\nuniform float refraction;\nuniform bool hasFog;\nuniform vec3 fogColor;\nuniform float fogNear;\nuniform float fogFar;\nvoid main(){\nif (!hasTexture1) {\ngl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);\n} else {\ngl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);\n}\nif (hasTextureCube1) {\nvec3 nReflection = normalize(vReflection);\nvec3 reflectionValue;\nif (refraction > 0.0) {\nreflectionValue = refract(nReflection, vNormal.xyz, refraction);\n} else {\nreflectionValue = -reflect(nReflection, vNormal.xyz);\n}\nvec4 cubeColor = textureCube(samplerCube1, vec3(-reflectionValue.x, -reflectionValue.y, reflectionValue.z));\ngl_FragColor = vec4(mix(gl_FragColor.xyz, cubeColor.xyz, reflection), 1.0);\n}\nif (enablePicking) {\nif (hasPickingColors) {\ngl_FragColor = vPickingColor;\n} else {\ngl_FragColor = vec4(pickColor, 1.0);\n}\n}\nif (hasFog) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = smoothstep(fogNear, fogFar, depth);\ngl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);\n}\n}";
PhiloGL.Shaders=x})();(function(){var x=PhiloGL.Vec3,y=!!(navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox/)),r=function(l,d,f){f=v.merge({lights:{enable:false,ambient:{r:0.2,g:0.2,b:0.2},directional:{direction:{x:1,y:1,z:1},color:{r:0,g:0,b:0}}},effects:{fog:false}},f||{});this.program=f.program?l[f.program]:l;this.camera=d;this.models=[];this.config=f};r.prototype={add:function(){for(var l=0,d=this.models,f=arguments.length;l<f;l++){var h=arguments[l];h.id=h.id||
v.uid();d.push(h);this.defineBuffers(h)}},remove:function(l){var d=this.models;l=d.indexOf(l);l>-1&&d.splice(l,1)},getProgram:function(l){var d=this.program;if(d.$$family!="program"&&l&&l.program){d=d[l.program];d.use()}return d},defineBuffers:function(l){var d=this.getProgram(l),f=l.dynamic;l.dynamic=true;l.setState(d);l.dynamic=f;l.unsetState(d)},beforeRender:function(l){this.setupLighting(l);this.setupEffects(l);var d=this.camera,f=d.position,h=d.view;d=d.projection;var j=h.mulMat4(d),c=j.invert();
l.setUniforms({cameraPosition:[f.x,f.y,f.z],projectionMatrix:d,viewMatrix:h,viewProjectionMatrix:j,viewInverseMatrix:h.invert(),viewProjectionInverseMatrix:c})},setupLighting:function(l){var d=this.config.lights,f=d.ambient,h=d.directional,j=h.color,c=h.direction,k=d.enable;d=d.points&&v.splat(d.points)||[];h=d.length;var i=[],m=[],s=[],z=[];c=(new x(c.x,c.y,c.z)).$unit().$scale(-1);l.setUniform("enableLights",k);if(k){l.setUniform("ambientColor",[f.r,f.g,f.b]);l.setUniform("directionalColor",[j.r,
j.g,j.b]);l.setUniform("lightingDirection",[c.x,c.y,c.z]);l.setUniform("numberPoints",h);for(f=0;f<h;f++){k=d[f];j=k.position;c=k.color||k.diffuse;k=k.specular;i.push(j.x,j.y,j.z);m.push(c.r,c.g,c.b);s.push(+!!k);k?z.push(k.r,k.g,k.b):z.push(0,0,0)}l.setUniforms({pointLocation:i,pointColor:m});l.setUniforms({enableSpecular:s,pointSpecularColor:z})}},setupEffects:function(l){var d=this.config.effects.fog,f=d.color||{r:0.5,g:0.5,b:0.5};d?l.setUniforms({hasFog:true,fogNear:d.near,fogFar:d.far,fogColor:[f.r,
f.g,f.b]}):l.setUniform("hasFog",false)},render:function(l){l=l||{};var d=this.camera,f=this.program,h=l.renderProgram,j=v.type(f);j=!h&&j=="object";l=v.extend({onBeforeRender:v.empty,onAfterRender:v.empty},l||{});!j&&this.beforeRender(h||f);for(var c=0,k=this.models,i=k.length;c<i;++c){var m=k[c];if(m.display){f=h||this.getProgram(m);j&&this.beforeRender(f);m.onBeforeRender(f,d);l.onBeforeRender(m,c);this.renderObject(m,f);l.onAfterRender(m,c);m.onAfterRender(f,d)}}},renderToTexture:function(l,d){d=
d||{};var f=M.textures[l+"-texture"],h=M.textureMemo[l+"-texture"];this.render(d);o.bindTexture(h.textureType,f);o.generateMipmap(h.textureType);o.bindTexture(h.textureType,null)},renderObject:function(l,d){var f=this.camera,h=l.matrix,j=f.view.mulMat4(h),c=j.invert(),k=c.transpose();l.setState(d);d.setUniforms({objectMatrix:h,worldMatrix:j,worldInverseMatrix:c,worldInverseTransposeMatrix:k});if(l.render)l.render(o,d,f);else l.$indicesLength?o.drawElements(l.drawType!==undefined?o.get(l.drawType):
o.TRIANGLES,l.$indicesLength,o.UNSIGNED_SHORT,0):o.drawArrays(l.drawType!==undefined?o.get(l.drawType):o.TRIANGLES,0,l.$verticesLength/3);l.unsetState(d)},setupPicking:function(){var l=PhiloGL.Program.fromDefaultShaders();M.setFrameBuffer("$picking",{width:5,height:1,bindToTexture:{parameters:[{name:"TEXTURE_ MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR",generateMipmap:y}]},bindToRenderBuffer:true});M.setFrameBuffer("$picking",false);this.pickingProgram=l},pick:function(l,
d){this.pickingProgram||this.setupPicking();var f={},h=[],j=M.usedProgram,c=this.pickingProgram,k=this.camera,i=k.target,m=k.aspect,s=this.config,z=s.lights.enable,t=s.effects.fog,B=o.canvas.width,a=o.canvas.height,b=this.unproject([l*2/B-1,1-d*2/a,1],k),g=new Uint8Array(4);this.camera.target=b;this.camera.update();s.lights.enable=false;s.effects.fog=false;M.setFrameBuffer("$picking",true);c.use();c.setUniform("enablePicking",true);o.disable(o.BLEND);o.viewport(0,0,5,1);o.clear(o.COLOR_BUFFER_BIT|
o.DEPTH_BUFFER_BIT);o.readPixels(0,0,1,1,o.RGBA,o.UNSIGNED_BYTE,g);this.renderPickingScene({background:g[0]+g[1]*256+g[2]*65536,o3dHash:f,o3dList:h,hash:[]});o.readPixels(2,0,1,1,o.RGBA,o.UNSIGNED_BYTE,g);b=[g[0],g[1],g[2]].join();b=f[b];var n;if(!b)for(var p=0,q=h.length;p<q;p++){b=h[p];n=b.pick(g);if(n!==false)b.$pickingIndex=n;else b=false}M.setFrameBuffer("$picking",false);M.setTexture("$picking-texture",false);c.setUniform("enablePicking",false);s.lights.enable=z;s.effects.fog=t;j&&j.use();o.viewport(0,
0,B,a);k.target=i;k.aspect=m;k.update();this.o3dHash=f;this.o3dList=h;this.pixel=g;this.capture=void 0;return b&&b.pickable&&b},unproject:function(l,d){return d.view.invert().mulMat4(d.projection.invert()).mulVec3(l)},renderPickingScene:function(l){if(this.config.renderPickingScene)this.config.renderPickingScene.call(this,l);else{var d=this.pickingProgram,f=l.o3dHash,h=l.o3dList,j=l.background,c=l.hash,k=0;this.renderToTexture("$picking",{renderProgram:d,onBeforeRender:function(i,m){if(m==j)k=1;var s=
m+k,z=!!i.pickingColors;d.setUniform("hasPickingColors",z);if(z)h.push(i);else{c[0]=s%256;c[1]=(s/256>>0)%256;c[2]=(s/65536>>0)%256;d.setUniform("pickColor",[c[0]/255,c[1]/255,c[2]/255]);f[c.join()]=i}}})}},resetPicking:v.empty};r.MAX_TEXTURES=10;r.MAX_POINT_LIGHTS=50;r.PICKING_RES=4;PhiloGL.Scene=r})();(function(){function x(y,r){for(var l=this.workers=[];r--;)l.push(new Worker(y))}x.prototype={map:function(y){var r=this.workers,l=this.configs=[],d=0;for(r=r.length;d<r;d++)l.push(y&&y(d));return this},
reduce:function(y){for(var r=y.reduceFn,l=this.workers,d=this.configs,f=l.length,h=y.initialValue,j=function(m){f--;h=h===undefined?m.data:r(h,m.data);if(f==0)y.onComplete(h)},c=0,k=f;c<k;c++){var i=l[c];i.onmessage=j;i.postMessage(d[c])}return this}};PhiloGL.WorkerGroup=x})();(function(){var x=function(h){this.opt=v.merge({delay:0,duration:1E3,transition:function(j){return j},onCompute:v.empty,onComplete:v.empty},h||{})},y=x.Queue=[];x.prototype={time:null,start:function(h){this.opt=v.merge(this.opt,
h||{});this.time=v.time();this.animating=true;y.push(this)},step:function(){if(this.animating){var h=v.time(),j=this.time,c=this.opt,k=c.delay,i=c.duration,m=0;if(h<j+k)c.onCompute.call(this,m);else if(h<j+k+i){m=c.transition((h-j-k)/i);c.onCompute.call(this,m)}else{this.animating=false;c.onCompute.call(this,1);c.onComplete.call(this)}}}};x.compute=function(h,j,c){return h+(j-h)*c};x.Transition={linear:function(h){return h}};var r=x.Transition;(function(){var h=function(k,i){i=v.splat(i);return v.extend(k,
{easeIn:function(m){return k(m,i)},easeOut:function(m){return 1-k(1-m,i)},easeInOut:function(m){return m<=0.5?k(2*m,i)/2:(2-k(2*(1-m),i))/2}})},j={Pow:function(k,i){return Math.pow(k,i[0]||6)},Expo:function(k){return Math.pow(2,8*(k-1))},Circ:function(k){return 1-Math.sin(Math.acos(k))},Sine:function(k){return 1-Math.sin((1-k)*Math.PI/2)},Back:function(k,i){i=i[0]||1.618;return Math.pow(k,2)*((i+1)*k-i)},Bounce:function(k){for(var i,m=0,s=1;;m+=s,s/=2)if(k>=(7-4*m)/11){i=s*s-Math.pow((11-6*m-11*k)/
4,2);break}return i},Elastic:function(k,i){return Math.pow(2,10*--k)*Math.cos(20*k*Math.PI*(i[0]||1)/3)}},c;for(c in j)r[c]=h(j[c]);["Quad","Cubic","Quart","Quint"].forEach(function(k,i){r[k]=h(function(m){return Math.pow(m,[i+2])})})})();var l=self||window,d=function(){var h=[];if(y.length){for(var j=0,c=y.length,k;j<c;j++){k=y[j];k.step();k.animating&&h.push(k)}x.Queue=y=h}};if(l){var f=false;["webkitAnimationTime","mozAnimationTime","animationTime","webkitAnimationStartTime","mozAnimationStartTime",
"animationStartTime"].forEach(function(h){if(h in l){x.animationTime=function(){return l[h]};f=true}});if(!f)x.animationTime=v.time;f=false;["webkitRequestAnimationFrame","mozRequestAnimationFrame","requestAnimationFrame"].forEach(function(h){if(h in l){x.requestAnimationFrame=function(j){l[h](function(){d();j()})};f=true}});if(!f)x.requestAnimationFrame=function(h){setTimeout(function(){d();h()},1E3/60)}}PhiloGL.Fx=x})();(function(){var x={},y=function(){};y.postProcess=function(){var r=new PhiloGL.O3D.Plane({type:"x,y",
xlen:1,ylen:1,offset:0}),l=new PhiloGL.Camera(45,1,0.1,500,{position:{x:0,y:0,z:1.205}}),d=new PhiloGL.Scene({},l);return function(f){var h=M.program.$$family?M.program:M.program[f.program],j=f.fromTexture?v.splat(f.fromTexture):[],c=f.toFrameBuffer,k=!!f.toScreen,i=f.width||M.canvas.width,m=f.height||M.canvas.height;l.aspect=f.aspectRatio?f.aspectRatio:Math.max(m/i,i/m);l.update();d.program=h;r.textures=j;r.program=h;d.models.length||d.add(r);if(c){c in M.frameBufferMemo||M.setFrameBuffer(c,{width:i,
height:m,bindToTexture:{parameters:[{name:"TEXTURE_MAG_FILTER",value:"LINEAR"},{name:"TEXTURE_MIN_FILTER",value:"LINEAR_MIPMAP_NEAREST",generateMipmap:false}]},bindToRenderBuffer:true});h.use();M.setFrameBuffer(c,true);o.viewport(0,0,i,m);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);h.setUniforms(f.uniforms||{});d.renderToTexture(c);M.setFrameBuffer(c,false)}if(k){h.use();o.viewport(0,0,i,m);o.clear(o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT);h.setUniforms(f.uniforms||{});d.render()}return this}}();
x.Image=y;PhiloGL.Media=x})()})();
